<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GAHAN KHATIWODA OFFICIAL - Enhanced 100-Days-Challenge</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #1a2980;
            --secondary: #26d0ce;
            --accent: #EA4335;
            --success: #34A853;
            --warning: #FBBC05;
            --dark: #1a1a2e;
            --light: #f8f9fa;
            --gray: #6c757d;
        }
        
        body { 
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); 
            min-height: 100vh; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #333; 
            overflow-x: hidden;
        }
        
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.3s;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: var(--success);
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            100% { transform: rotate(360deg); }
        }
        
        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9998;
            max-width: 350px;
        }
        
        .toast {
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 15px;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            border-left: 4px solid var(--success);
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast.error { border-left-color: var(--accent); }
        .toast.warning { border-left-color: var(--warning); }
        .toast.info { border-left-color: var(--primary); }
        
        /* Top Navigation */
        .top-nav {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .nav-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .nav-btn {
            background: transparent;
            border: 1px solid #ddd;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .nav-btn:hover {
            background: var(--light);
            transform: translateY(-2px);
        }
        
        .nav-btn.primary {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        /* Enhanced Visitor Counter */
        .visitor-counter {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(20px);
            color: white;
            padding: 20px 40px;
            border-radius: 20px;
            text-align: center;
            border: 2px solid rgba(0, 255, 0, 0.3);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: flex;
            align-items: center;
            gap: 30px;
            white-space: nowrap;
            min-width: 600px;
        }
        
        .counter-header {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--dark);
            color: #00ff00;
            padding: 6px 20px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            border: 1px solid rgba(0, 255, 0, 0.3);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        
        .counter-item {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }
        
        .counter-icon {
            font-size: 24px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.1);
        }
        
        .counter-content {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            flex: 1;
        }
        
        .counter-value {
            font-size: 28px;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            min-width: 60px;
        }
        
        .counter-label {
            font-size: 12px;
            color: #aaa;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 2px;
        }
        
        .counter-trend {
            font-size: 11px;
            margin-top: 3px;
        }
        
        .trend-up { color: #00ff00; }
        .trend-down { color: #ff4444; }
        
        .counter-separator {
            color: rgba(255, 255, 255, 0.2);
            font-size: 30px;
            font-weight: 100;
        }
        
        /* Main Container */
        .main-container {
            background: white;
            border-radius: 25px;
            padding: 50px;
            max-width: 900px;
            width: 90%;
            box-shadow: 0 25px 60px rgba(0,0,0,0.3);
            margin: 200px auto 50px;
            position: relative;
        }
        
        .section-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .section-title {
            font-size: 3rem;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }
        
        .section-subtitle {
            color: var(--gray);
            font-size: 1.2rem;
            font-weight: 300;
        }
        
        /* Login Form */
        .login-form {
            background: var(--light);
            padding: 40px;
            border-radius: 20px;
            margin: 30px 0;
        }
        
        .form-tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .tab-btn {
            padding: 15px 30px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: var(--gray);
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 10px;
            color: #555;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .form-input {
            width: 100%;
            padding: 18px 20px;
            border: 2px solid #ddd;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s;
            background: white;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 41, 128, 0.1);
        }
        
        .form-input.with-icon {
            padding-left: 50px;
        }
        
        .input-icon {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
        }
        
        .input-wrapper {
            position: relative;
        }
        
        .password-toggle {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--gray);
            cursor: pointer;
            font-size: 18px;
        }
        
        .login-btn {
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            padding: 20px 0;
            font-size: 18px;
            font-weight: bold;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            transition: all 0.3s;
            width: 100%;
        }
        
        .login-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(26, 41, 128, 0.3);
        }
        
        .login-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }
        
        .google-signin-container {
            text-align: center;
            margin: 30px 0;
        }
        
        .divider {
            display: flex;
            align-items: center;
            margin: 30px 0;
            color: var(--gray);
        }
        
        .divider::before, .divider::after {
            content: "";
            flex: 1;
            border-bottom: 1px solid #e9ecef;
        }
        
        .divider span {
            padding: 0 20px;
            font-size: 14px;
        }
        
        /* Features Grid */
        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin: 50px 0;
        }
        
        .feature-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            border: 2px solid #e9ecef;
            transition: all 0.3s;
            text-align: center;
        }
        
        .feature-card:hover {
            transform: translateY(-10px);
            border-color: var(--primary);
            box-shadow: 0 15px 30px rgba(0,0,0,0.1);
        }
        
        .feature-icon {
            font-size: 40px;
            margin-bottom: 20px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .feature-title {
            font-size: 20px;
            margin-bottom: 10px;
            color: var(--dark);
        }
        
        /* Success Screen */
        .success-screen {
            display: none;
            text-align: center;
        }
        
        .success-icon {
            font-size: 80px;
            color: var(--success);
            margin-bottom: 20px;
            animation: bounce 1s ease infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }
        
        .user-info-card {
            background: linear-gradient(135deg, #e8f0fe, #f0f7ff);
            padding: 25px;
            border-radius: 15px;
            margin: 30px 0;
            text-align: left;
            border: 2px solid #d0e2ff;
        }
        
        .user-info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }
        
        .user-info-row:last-child {
            border-bottom: none;
        }
        
        .content-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 40px 0;
        }
        
        .content-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid #e9ecef;
        }
        
        .content-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .content-card.odd { border-top: 5px solid #FF9800; }
        .content-card.even { border-top: 5px solid #2196F3; }
        .content-card.obj { border-top: 5px solid #9C27B0; }
        
        /* Analytics Modal */
        .analytics-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0,0,0,0.5);
        }
        
        .modal-tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .modal-tab {
            padding: 12px 25px;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--gray);
            font-weight: 500;
            border-bottom: 3px solid transparent;
        }
        
        .modal-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: var(--light);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 14px;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .chart-container {
            height: 200px;
            margin: 30px 0;
            position: relative;
        }
        
        /* Privacy Modal */
        .privacy-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }
        
        .privacy-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 700px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .visitor-counter {
                min-width: 90%;
                padding: 15px 20px;
                gap: 15px;
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .counter-item {
                flex: 0 0 calc(33.333% - 20px);
                justify-content: center;
            }
            
            .counter-separator {
                display: none;
            }
            
            .main-container {
                padding: 30px;
                margin-top: 160px;
            }
            
            .section-title {
                font-size: 2rem;
            }
            
            .top-nav {
                padding: 12px 20px;
            }
            
            .nav-btn span {
                display: none;
            }
            
            .nav-btn {
                padding: 8px 12px;
            }
        }
        
        @media (max-width: 480px) {
            .visitor-counter {
                top: 70px;
                flex-direction: column;
                gap: 10px;
            }
            
            .counter-item {
                flex: 0 0 100%;
                justify-content: flex-start;
            }
            
            .counter-separator {
                display: block;
                width: 80%;
                height: 1px;
                background: rgba(255,255,255,0.2);
                margin: 10px 0;
            }
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease forwards;
        }
        
        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--secondary);
        }
    </style>
</head>
<body>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay">
    <div class="loading-spinner"></div>
    <div style="color: white; margin-top: 20px;">Initializing Enhanced Tracking System...</div>
    <div id="loadingProgress" style="color: #aaa; font-size: 14px; margin-top: 10px;"></div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<!-- Top Navigation -->
<div class="top-nav">
    <div class="logo-container">
        <div class="logo">GAHAN KHATIWODA</div>
        <div style="color: var(--gray); font-size: 14px;">Enhanced Visitor Tracking</div>
    </div>
    
    <div class="nav-controls">
        <button class="nav-btn" onclick="showPrivacyModal()">
            <i class="fas fa-shield-alt"></i>
            <span>Privacy</span>
        </button>
        <button class="nav-btn" onclick="showAnalyticsModal()">
            <i class="fas fa-chart-bar"></i>
            <span>Analytics</span>
        </button>
        <button class="nav-btn primary" onclick="toggleDarkMode()">
            <i class="fas fa-moon"></i>
            <span>Theme</span>
        </button>
    </div>
</div>

<!-- Enhanced Visitor Counter -->
<div class="visitor-counter">
    <div class="counter-header">Gahan's Visitors</div>
    
    <div class="counter-item">
        <div class="counter-icon" style="color: #00ff00;">
            <i class="fas fa-users"></i>
        </div>
        <div class="counter-content">
            <div class="counter-value" id="totalVisitors">0000</div>
            <div class="counter-label">Total Visitors</div>
            <div class="counter-trend trend-up" id="totalTrend">+12 today</div>
        </div>
    </div>
    
    <div class="counter-separator">|</div>
    
    <div class="counter-item">
        <div class="counter-icon" style="color: #4285F4;">
            <i class="fas fa-user-check"></i>
        </div>
        <div class="counter-content">
            <div class="counter-value" id="uniqueVisitors">0000</div>
            <div class="counter-label">Unique Visitors</div>
            <div class="counter-trend" id="uniqueTrend">Returning: 68%</div>
        </div>
    </div>
    
    <div class="counter-separator">|</div>
    
    <div class="counter-item">
        <div class="counter-icon" style="color: #EA4335;">
            <i class="fas fa-circle"></i>
        </div>
        <div class="counter-content">
            <div class="counter-value" id="liveVisitors">00</div>
            <div class="counter-label">Live Now</div>
            <div class="counter-trend" id="liveActivity">Active in last 5 min</div>
        </div>
    </div>
</div>

<!-- Main Container -->
<div class="main-container">
    <!-- Login Screen -->
    <div id="loginScreen">
        <div class="section-header">
            <h1 class="section-title">100-DAYS-CHALLENGE</h1>
            <h2 class="section-subtitle">Computer Science â€¢ SEE 2082</h2>
            <p style="color: var(--gray); margin-top: 20px; font-size: 18px;">
                Complete Subjective & Objective Practice Sets with Enhanced Analytics
            </p>
        </div>
        
        <div class="login-form">
            <div class="form-tabs">
                <button class="tab-btn active" onclick="switchTab('traditional')">
                    <i class="fas fa-user-lock"></i> Traditional Login
                </button>
                <button class="tab-btn" onclick="switchTab('google')">
                    <i class="fab fa-google"></i> Google Login
                </button>
            </div>
            
            <!-- Traditional Login Tab -->
            <div id="traditionalTab" class="tab-content active">
                <div class="form-group">
                    <label for="username">
                        <span>Username / Email</span>
                        <span style="font-size: 12px; color: var(--gray);">
                            <i class="fas fa-info-circle"></i> Contact admin for credentials
                        </span>
                    </label>
                    <div class="input-wrapper">
                        <i class="fas fa-user input-icon"></i>
                        <input type="text" id="username" class="form-input with-icon" 
                               placeholder="Enter your username or email" 
                               autocomplete="username">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="password">Password</label>
                    <div class="input-wrapper">
                        <i class="fas fa-key input-icon"></i>
                        <input type="password" id="password" class="form-input with-icon" 
                               placeholder="Enter your password" 
                               autocomplete="current-password">
                        <button type="button" class="password-toggle" onclick="togglePassword()">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                
                <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="rememberMe" style="width: auto;">
                    <label for="rememberMe" style="margin: 0; font-weight: normal;">Remember me for 24 hours</label>
                </div>
                
                <button class="login-btn" onclick="loginUser()" id="loginBtn">
                    <i class="fas fa-sign-in-alt"></i>
                    <span>Login to Access Content</span>
                </button>
                
                <div id="errorMessage" style="color: var(--accent); margin-top: 15px; text-align: center; display: none;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span id="errorText">Invalid username or password. Please try again.</span>
                </div>
            </div>
            
            <!-- Google Login Tab -->
            <div id="googleTab" class="tab-content">
                <div class="google-signin-container">
                    <p style="margin-bottom: 20px; color: var(--gray);">
                        Sign in with your Google account for faster access
                    </p>
                    
                    <div id="g_id_onload"
                         data-client_id="789365890180-30fpjid0955op8rldf1js02br0t7jql3.apps.googleusercontent.com"
                         data-context="signin"
                         data-ux_mode="popup"
                         data-callback="handleCredentialResponse"
                         data-auto_prompt="false"
                         data-itp_support="true">
                    </div>
                    
                    <div class="g_id_signin"
                         data-type="standard"
                         data-shape="rectangular"
                         data-theme="outline"
                         data-text="signin_with"
                         data-size="large"
                         data-logo_alignment="left"
                         data-width="100%">
                    </div>
                    
                    <div id="googleUserInfo" style="margin-top: 30px; display: none;">
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                            <img id="googleAvatar" style="width: 60px; height: 60px; border-radius: 50%; margin: 0 auto 15px; display: block;" src="" alt="Profile">
                            <h3 id="googleName" style="color: var(--primary);"></h3>
                            <p id="googleEmail" style="color: var(--gray); font-family: 'Courier New';"></p>
                            <button onclick="loginWithGoogle()" style="background: var(--success); color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; margin-top: 15px; font-size: 16px; width: 100%;">
                                <i class="fas fa-check-circle"></i> Continue with this Google Account
                            </button>
                            <button onclick="googleLogout()" style="background: transparent; color: var(--gray); border: 1px solid #ddd; padding: 8px 20px; border-radius: 5px; cursor: pointer; margin-top: 10px; font-size: 14px; width: 100%;">
                                <i class="fas fa-sync"></i> Use different account
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="divider">
                <span>Security Information</span>
            </div>
            
            <div style="text-align: center; color: var(--gray); font-size: 13px;">
                <p><i class="fas fa-lock"></i> All connections are encrypted with SSL/TLS</p>
                <p><i class="fas fa-database"></i> Visitor tracking complies with privacy regulations</p>
                <p><i class="fas fa-clock"></i> Sessions expire after 30 minutes of inactivity</p>
            </div>
        </div>
        
        <!-- Features Section -->
        <div class="features-grid">
            <div class="feature-card">
                <div class="feature-icon">
                    <i class="fas fa-book-open"></i>
                </div>
                <h3 class="feature-title">Odd Days Sets</h3>
                <p style="color: var(--gray);">Comprehensive subjective question bank with detailed solutions</p>
            </div>
            
            <div class="feature-card">
                <div class="feature-icon">
                    <i class="fas fa-book"></i>
                </div>
                <h3 class="feature-title">Even Days Sets</h3>
                <p style="color: var(--gray);">Advanced practice questions with step-by-step explanations</p>
            </div>
            
            <div class="feature-card">
                <div class="feature-icon">
                    <i class="fas fa-check-double"></i>
                </div>
                <h3 class="feature-title">Objective Sets</h3>
                <p style="color: var(--gray);">MCQ and quick review with instant feedback system</p>
            </div>
        </div>
    </div>
    
    <!-- Success Screen -->
    <div class="success-screen" id="successScreen">
        <div class="section-header">
            <div class="success-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <h1 class="section-title">Access Granted!</h1>
            <h2 class="section-subtitle">Welcome to Enhanced Learning Platform</h2>
        </div>
        
        <div class="user-info-card">
            <h3 style="color: var(--primary); margin-bottom: 20px;">
                <i class="fas fa-user-circle"></i> User Information
            </h3>
            <div class="user-info-row">
                <span style="font-weight: 600;">Username:</span>
                <span id="displayUsername">Loading...</span>
            </div>
            <div class="user-info-row">
                <span style="font-weight: 600;">Email:</span>
                <span id="displayEmail">Loading...</span>
            </div>
            <div class="user-info-row">
                <span style="font-weight: 600;">Login Method:</span>
                <span id="displayMethod">Loading...</span>
            </div>
            <div class="user-info-row">
                <span style="font-weight: 600;">Session Started:</span>
                <span id="displaySessionTime">Loading...</span>
            </div>
            <div class="user-info-row">
                <span style="font-weight: 600;">Your Visitor ID:</span>
                <span id="displayVisitorId" style="font-family: 'Courier New'; color: var(--primary);">Loading...</span>
            </div>
        </div>
        
        <p style="color: var(--gray); margin: 30px 0; font-size: 16px;">
            <i class="fas fa-sync-alt"></i> Your progress is automatically saved. Choose content to begin:
        </p>
        
        <div class="content-grid">
            <div class="content-card odd" onclick="goToContent('odd')">
                <div style="font-size: 40px; color: #FF9800; margin-bottom: 15px;">
                    <i class="fas fa-file-alt"></i>
                </div>
                <h3 style="color: var(--dark); margin-bottom: 10px;">ODD-DAYS SETS</h3>
                <p style="color: var(--gray); font-size: 14px;">Subjective practice with solutions</p>
                <div style="margin-top: 15px; color: #FF9800; font-size: 12px;">
                    <i class="fas fa-arrow-right"></i> Click to access
                </div>
            </div>
            
            <div class="content-card even" onclick="goToContent('even')">
                <div style="font-size: 40px; color: #2196F3; margin-bottom: 15px;">
                    <i class="fas fa-book"></i>
                </div>
                <h3 style="color: var(--dark); margin-bottom: 10px;">EVEN-DAYS SETS</h3>
                <p style="color: var(--gray); font-size: 14px;">Advanced questions & explanations</p>
                <div style="margin-top: 15px; color: #2196F3; font-size: 12px;">
                    <i class="fas fa-arrow-right"></i> Click to access
                </div>
            </div>
            
            <div class="content-card obj" onclick="goToContent('obj')">
                <div style="font-size: 40px; color: #9C27B0; margin-bottom: 15px;">
                    <i class="fas fa-check-double"></i>
                </div>
                <h3 style="color: var(--dark); margin-bottom: 10px;">OBJECTIVE SETS</h3>
                <p style="color: var(--gray); font-size: 14px;">MCQ practice with instant feedback</p>
                <div style="margin-top: 15px; color: #9C27B0; font-size: 12px;">
                    <i class="fas fa-arrow-right"></i> Click to access
                </div>
            </div>
        </div>
        
        <div style="display: flex; gap: 15px; justify-content: center; margin-top: 40px;">
            <button onclick="logout()" style="background: var(--accent); color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-size: 16px; display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
            <button onclick="showSessionInfo()" style="background: var(--primary); color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-size: 16px; display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-info-circle"></i> Session Info
            </button>
        </div>
    </div>
</div>

<!-- Analytics Modal -->
<div id="analyticsModal" class="analytics-modal">
    <div class="modal-content">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
            <h2 style="color: var(--primary);">
                <i class="fas fa-chart-bar"></i> Advanced Analytics
            </h2>
            <button onclick="hideAnalyticsModal()" style="background: none; border: none; font-size: 24px; color: var(--gray); cursor: pointer;">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="modal-tabs">
            <button class="modal-tab active" onclick="switchAnalyticsTab('overview')">
                <i class="fas fa-tachometer-alt"></i> Overview
            </button>
            <button class="modal-tab" onclick="switchAnalyticsTab('realtime')">
                <i class="fas fa-bolt"></i> Real-Time
            </button>
            <button class="modal-tab" onclick="switchAnalyticsTab('geography')">
                <i class="fas fa-globe"></i> Geography
            </button>
            <button class="modal-tab" onclick="switchAnalyticsTab('devices')">
                <i class="fas fa-mobile-alt"></i> Devices
            </button>
        </div>
        
        <!-- Overview Tab -->
        <div id="overviewTab" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="modalTotal">0</div>
                    <div class="stat-label">Total Visitors</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="modalUnique">0</div>
                    <div class="stat-label">Unique Visitors</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="modalLive">0</div>
                    <div class="stat-label">Live Now</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="modalBounce">0%</div>
                    <div class="stat-label">Bounce Rate</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="modalDuration">0s</div>
                    <div class="stat-label">Avg. Duration</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="modalPages">0</div>
                    <div class="stat-label">Pages/Session</div>
                </div>
            </div>
            
            <div style="margin: 30px 0;">
                <h4 style="color: var(--dark); margin-bottom: 15px;">
                    <i class="fas fa-chart-line"></i> Today's Traffic
                </h4>
                <div class="chart-container" id="hourlyChart">
                    <!-- Chart will be rendered here -->
                    <div style="display: flex; height: 100%; align-items: flex-end; gap: 10px;">
                        <div style="flex: 1; background: var(--primary); border-radius: 5px;"></div>
                        <div style="flex: 1; background: var(--primary); height: 60%; border-radius: 5px;"></div>
                        <div style="flex: 1; background: var(--primary); height: 80%; border-radius: 5px;"></div>
                        <div style="flex: 1; background: var(--primary); height: 100%; border-radius: 5px;"></div>
                        <div style="flex: 1; background: var(--primary); height: 70%; border-radius: 5px;"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Real-Time Tab -->
        <div id="realtimeTab" class="tab-content">
            <h4 style="color: var(--dark); margin-bottom: 15px;">
                <i class="fas fa-users"></i> Live Visitors
            </h4>
            <div id="liveVisitorsList" style="max-height: 300px; overflow-y: auto;">
                <!-- Live visitors will be listed here -->
                <div style="text-align: center; padding: 40px; color: var(--gray);">
                    <i class="fas fa-sync fa-spin" style="font-size: 30px; margin-bottom: 15px;"></i>
                    <p>Loading real-time data...</p>
                </div>
            </div>
        </div>
        
        <!-- Geography Tab -->
        <div id="geographyTab" class="tab-content">
            <h4 style="color: var(--dark); margin-bottom: 15px;">
                <i class="fas fa-map-marker-alt"></i> Visitor Locations
            </h4>
            <div id="countryList" style="max-height: 300px; overflow-y: auto;">
                <!-- Country list will be here -->
            </div>
        </div>
        
        <!-- Devices Tab -->
        <div id="devicesTab" class="tab-content">
            <h4 style="color: var(--dark); margin-bottom: 15px;">
                <i class="fas fa-laptop"></i> Device Distribution
            </h4>
            <div id="deviceStats">
                <!-- Device stats will be here -->
            </div>
        </div>
        
        <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #e9ecef;">
            <p style="color: var(--gray); font-size: 12px; text-align: center;">
                <i class="fas fa-shield-alt"></i> Data updated every 30 seconds â€¢ Last updated: <span id="lastUpdateTime">Just now</span>
            </p>
        </div>
    </div>
</div>

<!-- Privacy Modal -->
<div id="privacyModal" class="privacy-modal">
    <div class="privacy-content">
        <h2 style="color: var(--primary); margin-bottom: 20px;">
            <i class="fas fa-shield-alt"></i> Privacy & Data Collection Notice
        </h2>
        
        <div style="margin-bottom: 25px;">
            <h4 style="color: var(--dark); margin-bottom: 10px;">What We Collect:</h4>
            <ul style="color: var(--gray); line-height: 1.8; padding-left: 20px;">
                <li><strong>Session Data:</strong> Anonymous session identifiers</li>
                <li><strong>Technical Information:</strong> Browser type, device type, screen resolution</li>
                <li><strong>Usage Data:</strong> Pages visited, time spent, interactions</li>
                <li><strong>Location Data:</strong> Country-level location (no precise GPS)</li>
                <li><strong>Login Information:</strong> Only when you explicitly log in</li>
            </ul>
        </div>
        
        <div style="margin-bottom: 25px;">
            <h4 style="color: var(--dark); margin-bottom: 10px;">What We <strong>DO NOT</strong> Collect:</h4>
            <ul style="color: var(--gray); line-height: 1.8; padding-left: 20px;">
                <li>Personal identification without consent</li>
                <li>Precise location data</li>
                <li>Sensitive personal information</li>
                <li>Cross-site tracking data</li>
                <li>Persistent cookies without consent</li>
            </ul>
        </div>
        
        <div style="margin-bottom: 25px;">
            <h4 style="color: var(--dark); margin-bottom: 10px;">Data Usage:</h4>
            <p style="color: var(--gray); line-height: 1.6;">
                We use this data exclusively to improve the learning experience, 
                analyze content effectiveness, and prevent abuse. All data is 
                stored securely and anonymized where possible.
            </p>
        </div>
        
        <div style="display: flex; gap: 15px; margin-top: 30px;">
            <button onclick="acceptPrivacy()" style="background: var(--success); color: white; border: none; padding: 15px 30px; border-radius: 8px; cursor: pointer; font-size: 16px; flex: 1;">
                <i class="fas fa-check"></i> I Understand & Accept
            </button>
            <button onclick="showPrivacySettings()" style="background: var(--primary); color: white; border: none; padding: 15px 30px; border-radius: 8px; cursor: pointer; font-size: 16px; flex: 1;">
                <i class="fas fa-cog"></i> Privacy Settings
            </button>
            <button onclick="hidePrivacyModal()" style="background: transparent; color: var(--gray); border: 1px solid #ddd; padding: 15px 20px; border-radius: 8px; cursor: pointer; font-size: 16px;">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <p style="color: var(--gray); font-size: 12px; margin-top: 20px; text-align: center;">
            <i class="fas fa-info-circle"></i> You can change privacy settings anytime from the top navigation
        </p>
    </div>
</div>

<!-- Footer -->
<footer style="color: white; text-align: center; padding: 30px; opacity: 0.8;">
    <p style="margin-bottom: 10px;">Â© 2023 Gahan Khatiwoda Official â€¢ Enhanced Visitor Tracking System v2.0</p>
    <p style="font-size: 14px;">
        <i class="fas fa-heart" style="color: #ff4444;"></i> 
        Built with advanced analytics & privacy-first approach
    </p>
</footer>

<!-- Google Identity Services -->
<script src="https://accounts.google.com/gsi/client" async defer></script>

<!-- Enhanced JavaScript -->
<script>
// ======================================================================
// ENHANCED VISITOR TRACKING SYSTEM - FRONTEND
// ======================================================================

// Configuration
const CONFIG = {
    SHEET_URL: "https://script.google.com/macros/s/AKfycbwU7zYkNU0j4Pq3IqmyJGri17dHPCr2UspqrGCRECuZBdNaVp4iZSjLKvKlnwNu-Flu/exec",
    LOGIN_CHECK_URL: "https://script.google.com/macros/s/AKfycbxW52YW8GHm0OK7cJPnICiAkMt8EFDcU6laCi_tebb4syIDCpW4LRyMM_gBwwKs81Z-/exec",
    REFRESH_INTERVAL: 30000, // 30 seconds
    HEARTBEAT_INTERVAL: 120000, // 2 minutes
    INACTIVITY_TIMEOUT: 300000 // 5 minutes
};

// Global State
const AppState = {
    session: {
        id: null,
        visitorId: null,
        startTime: null,
        pageViews: 0,
        events: [],
        metadata: {}
    },
    user: {
        loggedIn: false,
        data: null,
        preferences: {}
    },
    analytics: {
        counters: { total: 0, unique: 0, live: 0 },
        trends: {},
        realTime: [],
        privacyAccepted: false
    },
    ui: {
        darkMode: false,
        activeTab: 'traditional',
        toastQueue: []
    }
};

// DOM Elements Cache
const Elements = {
    loading: document.getElementById('loadingOverlay'),
    loadingProgress: document.getElementById('loadingProgress'),
    toastContainer: document.getElementById('toastContainer'),
    totalVisitors: document.getElementById('totalVisitors'),
    uniqueVisitors: document.getElementById('uniqueVisitors'),
    liveVisitors: document.getElementById('liveVisitors'),
    totalTrend: document.getElementById('totalTrend'),
    uniqueTrend: document.getElementById('uniqueTrend'),
    liveActivity: document.getElementById('liveActivity'),
    loginScreen: document.getElementById('loginScreen'),
    successScreen: document.getElementById('successScreen'),
    loginBtn: document.getElementById('loginBtn'),
    errorMessage: document.getElementById('errorMessage'),
    errorText: document.getElementById('errorText'),
    analyticsModal: document.getElementById('analyticsModal'),
    privacyModal: document.getElementById('privacyModal')
};

// ======================================================================
// ENHANCED INITIALIZATION
// ======================================================================

async function initializeApp() {
    showLoading("Initializing Enhanced Tracking System...");
    
    try {
        // Step 1: Check privacy acceptance
        await checkPrivacyStatus();
        
        // Step 2: Initialize session tracking
        await initializeEnhancedSession();
        
        // Step 3: Load user preferences
        loadUserPreferences();
        
        // Step 4: Check existing login session
        await checkExistingLogin();
        
        // Step 5: Initialize analytics
        await initializeAnalytics();
        
        // Step 6: Set up event listeners
        setupEventListeners();
        
        // Step 7: Start background processes
        startBackgroundProcesses();
        
        // Step 8: Hide loading screen
        setTimeout(() => {
            hideLoading();
            showToast('System initialized successfully!', 'success');
        }, 1000);
        
    } catch (error) {
        console.error('Initialization error:', error);
        showToast('Initialization failed. Some features may not work.', 'error');
        hideLoading();
    }
}

// ======================================================================
// ENHANCED SESSION MANAGEMENT
// ======================================================================

async function initializeEnhancedSession() {
    console.log('ðŸ”„ Initializing enhanced session tracking...');
    
    // Generate or retrieve visitor ID
    let visitorId = localStorage.getItem('gahan_visitor_id_v2');
    const isNewVisitor = !visitorId;
    
    if (!visitorId) {
        visitorId = generateVisitorId();
        localStorage.setItem('gahan_visitor_id_v2', visitorId);
        localStorage.setItem('visitor_first_seen_v2', new Date().toISOString());
        localStorage.setItem('visitor_consent_v2', 'basic');
        console.log('ðŸ‘¤ New visitor created:', visitorId.substring(0, 20));
    }
    
    // Check session expiration
    const lastSessionTime = localStorage.getItem('last_session_time_v2');
    const now = Date.now();
    const sessionExpired = !lastSessionTime || (now - parseInt(lastSessionTime)) > (30 * 60 * 1000);
    
    // Generate session ID
    let sessionId;
    if (sessionExpired) {
        sessionId = generateSessionId(visitorId);
        localStorage.setItem('last_session_id_v2', sessionId);
        localStorage.setItem('last_session_time_v2', now.toString());
        console.log('ðŸ†• New session started:', sessionId.substring(0, 20));
        
        // Send session start event
        await sendTrackingEvent({
            type: 'session_start',
            eventType: 'session_start',
            isNewSession: true,
            isNewVisitor: isNewVisitor,
            metadata: {
                referrer: document.referrer || 'direct',
                screenResolution: `${window.screen.width}x${window.screen.height}`,
                colorDepth: window.screen.colorDepth,
                language: navigator.language,
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
            }
        });
    } else {
        sessionId = localStorage.getItem('last_session_id_v2') || generateSessionId(visitorId);
        console.log('ðŸ”„ Continuing existing session:', sessionId.substring(0, 20));
    }
    
    // Update AppState
    AppState.session = {
        id: sessionId,
        visitorId: visitorId,
        startTime: parseInt(lastSessionTime) || now,
        pageViews: 1,
        events: [],
        metadata: {
            userAgent: navigator.userAgent,
            platform: navigator.platform,
            cookiesEnabled: navigator.cookieEnabled,
            doNotTrack: navigator.doNotTrack || 'unspecified'
        }
    };
    
    // Send page view event
    setTimeout(async () => {
        await sendTrackingEvent({
            type: 'page_view',
            eventType: 'page_view',
            page: window.location.pathname,
            isNewSession: sessionExpired,
            isNewVisitor: false
        });
    }, 500);
    
    // Set up activity tracking
    setupEnhancedActivityTracking();
    
    return { sessionId, visitorId };
}

function generateVisitorId() {
    const random = Math.random().toString(36).substr(2, 9);
    const timestamp = Date.now().toString(36);
    const hash = btoa(random + timestamp).substr(0, 20);
    return 'vis_' + hash;
}

function generateSessionId(visitorId) {
    const timestamp = Date.now();
    const random = Math.random().toString(36).substr(2, 9);
    const hash = btoa(visitorId + timestamp + random).substr(0, 32);
    return 'sess_' + hash;
}

// ======================================================================
// ENHANCED TRACKING EVENTS
// ======================================================================

async function sendTrackingEvent(eventData) {
    const baseData = {
        sessionId: AppState.session.id,
        visitorId: AppState.session.visitorId,
        timestamp: new Date().toISOString(),
        userAgent: navigator.userAgent.substring(0, 200),
        referrer: document.referrer || 'direct',
        page: window.location.pathname,
        screenResolution: `${window.screen.width}x${window.screen.height}`,
        language: navigator.language,
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
        ...eventData
    };
    
    // Add user data if logged in
    if (AppState.user.loggedIn && AppState.user.data) {
        baseData.userId = AppState.user.data.username;
        baseData.userEmail = AppState.user.data.email;
    }
    
    console.log('ðŸ“¤ Sending tracking event:', {
        type: baseData.type,
        sessionId: baseData.sessionId?.substring(0, 15)
    });
    
    try {
        // Use Beacon API for better reliability
        if (navigator.sendBeacon) {
            const blob = new Blob([JSON.stringify(baseData)], { type: 'application/json' });
            navigator.sendBeacon(CONFIG.SHEET_URL, blob);
        } else {
            // Fallback to fetch
            await fetch(CONFIG.SHEET_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(baseData)
            });
        }
        
        // Store event locally
        AppState.session.events.push({
            ...baseData,
            sentAt: new Date().toISOString()
        });
        
        // Keep only last 100 events
        if (AppState.session.events.length > 100) {
            AppState.session.events = AppState.session.events.slice(-100);
        }
        
        console.log('âœ… Event sent successfully:', baseData.type);
        return true;
    } catch (error) {
        console.error('âŒ Failed to send event:', error);
        
        // Queue failed event for retry
        queueEventForRetry(baseData);
        return false;
    }
}

function queueEventForRetry(eventData) {
    const failedEvents = JSON.parse(localStorage.getItem('failed_events') || '[]');
    failedEvents.push({
        ...eventData,
        retryCount: 0,
        lastAttempt: new Date().toISOString()
    });
    
    // Keep only last 50 failed events
    if (failedEvents.length > 50) {
        failedEvents = failedEvents.slice(-50);
    }
    
    localStorage.setItem('failed_events', JSON.stringify(failedEvents));
}

async function retryFailedEvents() {
    const failedEvents = JSON.parse(localStorage.getItem('failed_events') || '[]');
    const successful = [];
    
    for (const event of failedEvents) {
        if (event.retryCount >= 3) continue; // Max 3 retries
        
        try {
            await fetch(CONFIG.SHEET_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(event)
            });
            
            successful.push(event);
            console.log('ðŸ”„ Retry successful for event:', event.type);
        } catch (error) {
            event.retryCount++;
            event.lastAttempt = new Date().toISOString();
        }
    }
    
    // Remove successful events
    const remainingEvents = failedEvents.filter(e => !successful.includes(e));
    localStorage.setItem('failed_events', JSON.stringify(remainingEvents));
}

// ======================================================================
// ENHANCED ACTIVITY TRACKING
// ======================================================================

function setupEnhancedActivityTracking() {
    let activityTimeout;
    let lastHeartbeat = Date.now();
    let idleTime = 0;
    
    // Activity events to track
    const activityEvents = [
        'mousemove', 'mousedown', 'keydown', 'keypress', 'keyup',
        'click', 'dblclick', 'scroll', 'touchstart', 'touchmove',
        'wheel', 'resize', 'focus', 'blur'
    ];
    
    // Reset activity timer function
    const resetActivityTimer = () => {
        clearTimeout(activityTimeout);
        idleTime = 0;
        
        // Check if heartbeat is needed (5 minutes idle)
        const now = Date.now();
        if (now - lastHeartbeat > CONFIG.INACTIVITY_TIMEOUT) {
            sendTrackingEvent({
                type: 'heartbeat',
                eventType: 'heartbeat',
                metadata: { idleTime: Math.round((now - lastHeartbeat) / 1000) }
            });
            lastHeartbeat = now;
        }
        
        // Update session time
        localStorage.setItem('last_session_time_v2', Date.now().toString());
        
        // Set new timeout
        activityTimeout = setTimeout(() => {
            idleTime += CONFIG.INACTIVITY_TIMEOUT;
        }, CONFIG.INACTIVITY_TIMEOUT);
    };
    
    // Attach event listeners
    activityEvents.forEach(event => {
        document.addEventListener(event, resetActivityTimer, { passive: true });
    });
    
    // Page visibility tracking
    document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
            sendTrackingEvent({
                type: 'page_hide',
                eventType: 'page_hide',
                metadata: { visibilityState: 'hidden' }
            });
        } else {
            sendTrackingEvent({
                type: 'page_show',
                eventType: 'page_show',
                metadata: { visibilityState: 'visible' }
            });
            resetActivityTimer();
        }
    });
    
    // Before unload event
    window.addEventListener('beforeunload', () => {
        sendTrackingEvent({
            type: 'session_end',
            eventType: 'session_end',
            metadata: {
                sessionDuration: Date.now() - AppState.session.startTime,
                pageViews: AppState.session.pageViews
            }
        });
        
        // Try to send as beacon
        if (navigator.sendBeacon) {
            const endEvent = {
                type: 'session_end',
                eventType: 'session_end',
                sessionId: AppState.session.id,
                visitorId: AppState.session.visitorId,
                timestamp: new Date().toISOString(),
                metadata: {
                    sessionDuration: Date.now() - AppState.session.startTime,
                    pageViews: AppState.session.pageViews
                }
            };
            
            const blob = new Blob([JSON.stringify(endEvent)], { type: 'application/json' });
            navigator.sendBeacon(CONFIG.SHEET_URL, blob);
        }
    });
    
    // Initial setup
    resetActivityTimer();
    
    // Periodic heartbeat (every 2 minutes when active)
    setInterval(() => {
        if (!document.hidden && idleTime < 60) { // Less than 60 seconds idle
            sendTrackingEvent({
                type: 'heartbeat',
                eventType: 'heartbeat',
                metadata: { periodic: true }
            });
        }
    }, CONFIG.HEARTBEAT_INTERVAL);
}

// ======================================================================
// ENHANCED COUNTER SYSTEM
// ======================================================================

async function updateEnhancedCounters() {
    try {
        const response = await fetch(`${CONFIG.SHEET_URL}?action=getStats&_=${Date.now()}`);
        const data = await response.json();
        
        if (data && data.total_visitors !== undefined) {
            // Store previous values for trend calculation
            const prevTotal = AppState.analytics.counters.total;
            const prevUnique = AppState.analytics.counters.unique;
            const prevLive = AppState.analytics.counters.live;
            
            // Update counters
            AppState.analytics.counters = {
                total: data.total_visitors || 0,
                unique: data.unique_visitors || 0,
                live: data.live_visitors || 0
            };
            
            // Calculate trends
            AppState.analytics.trends = {
                totalChange: AppState.analytics.counters.total - prevTotal,
                uniqueChange: AppState.analytics.counters.unique - prevUnique,
                liveChange: AppState.analytics.counters.live - prevLive,
                updateTime: new Date().toISOString()
            };
            
            // Update display
            updateCounterDisplay();
            
            // Update modal if open
            if (Elements.analyticsModal.style.display === 'flex') {
                updateAnalyticsModal();
            }
            
            return true;
        }
    } catch (error) {
        console.error('âŒ Failed to update counters:', error);
        showToast('Failed to update visitor counters', 'error');
        return false;
    }
}

function updateCounterDisplay() {
    const { total, unique, live } = AppState.analytics.counters;
    const { totalChange, uniqueChange } = AppState.analytics.trends;
    
    // Update numbers with animation
    animateNumber(Elements.totalVisitors, total, 4);
    animateNumber(Elements.uniqueVisitors, unique, 4);
    animateNumber(Elements.liveVisitors, live, 2);
    
    // Update trends
    if (totalChange > 0) {
        Elements.totalTrend.textContent = `+${totalChange} today`;
        Elements.totalTrend.className = 'counter-trend trend-up';
    } else if (totalChange < 0) {
        Elements.totalTrend.textContent = `${totalChange} today`;
        Elements.totalTrend.className = 'counter-trend trend-down';
    } else {
        Elements.totalTrend.textContent = 'No change today';
        Elements.totalTrend.className = 'counter-trend';
    }
    
    // Calculate returning rate (simplified)
    const returningRate = unique > 0 ? Math.round((total - unique) / total * 100) : 0;
    Elements.uniqueTrend.textContent = `Returning: ${returningRate}%`;
    
    // Update live activity text
    if (live > 0) {
        Elements.liveActivity.textContent = `${live} active now`;
    } else {
        Elements.liveActivity.textContent = 'No active visitors';
    }
}

function animateNumber(element, target, padding) {
    const current = parseInt(element.textContent) || 0;
    const duration = 500; // ms
    const steps = 20;
    const increment = (target - current) / steps;
    let step = 0;
    
    function update() {
        if (step < steps) {
            const value = Math.round(current + (increment * step));
            element.textContent = value.toString().padStart(padding, '0');
            step++;
            requestAnimationFrame(update);
        } else {
            element.textContent = target.toString().padStart(padding, '0');
        }
    }
    
    update();
}

// ======================================================================
// ENHANCED AUTHENTICATION SYSTEM
// ======================================================================

async function loginUser() {
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value;
    const rememberMe = document.getElementById('rememberMe').checked;
    
    // Validation
    if (!username || !password) {
        showError('Please enter both username and password');
        return;
    }
    
    // Show loading state
    const originalText = Elements.loginBtn.innerHTML;
    Elements.loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Authenticating...';
    Elements.loginBtn.disabled = true;
    hideError();
    
    try {
        // Check credentials
        const response = await fetch(`${CONFIG.LOGIN_CHECK_URL}?action=checkCred&username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`);
        const result = await response.json();
        
        if (result.success) {
            // Successful login
            await handleSuccessfulLogin({
                username: username,
                email: result.email || '',
                method: 'traditional',
                remember: rememberMe
            });
        } else {
            // Failed login
            showError('Invalid username or password');
            document.getElementById('password').value = '';
            document.getElementById('password').focus();
        }
    } catch (error) {
        showError('Network error. Please try again.');
        console.error('Login error:', error);
    } finally {
        // Reset button state
        Elements.loginBtn.innerHTML = originalText;
        Elements.loginBtn.disabled = false;
    }
}

async function handleCredentialResponse(response) {
    if (!response || !response.credential) {
        showError('Google Sign-In failed. Please try again.');
        return;
    }
    
    try {
        const token = response.credential;
        const payload = JSON.parse(atob(token.split('.')[1]));
        
        const googleUserData = {
            email: payload.email,
            name: payload.name,
            picture: payload.picture,
            given_name: payload.given_name,
            family_name: payload.family_name,
            email_verified: payload.email_verified,
            token: token,
            timestamp: new Date().toISOString()
        };
        
        // Store Google user data
        localStorage.setItem('google_user_data', JSON.stringify(googleUserData));
        
        // Update UI
        document.getElementById('googleUserInfo').style.display = 'block';
        document.getElementById('googleAvatar').src = googleUserData.picture;
        document.getElementById('googleName').textContent = googleUserData.name;
        document.getElementById('googleEmail').textContent = googleUserData.email;
        document.querySelector('.g_id_signin').style.display = 'none';
        
        // Automatically proceed after 1 second
        setTimeout(loginWithGoogle, 1000);
        
    } catch (error) {
        showError('Failed to process Google Sign-In.');
        console.error('Google Sign-In error:', error);
    }
}

async function loginWithGoogle() {
    const googleUserData = JSON.parse(localStorage.getItem('google_user_data'));
    
    if (!googleUserData) {
        showError('Please sign in with Google first');
        return;
    }
    
    const googleEmail = googleUserData.email;
    
    try {
        // Check if email is authorized
        const response = await fetch(`${CONFIG.LOGIN_CHECK_URL}?action=checkEmail&email=${encodeURIComponent(googleEmail)}`);
        const result = await response.json();
        
        if (!result.success) {
            showError('Your Google account is not authorized. Contact admin for access.');
            return;
        }
        
        // Successful login
        await handleSuccessfulLogin({
            username: result.username || googleEmail.split('@')[0],
            email: googleEmail,
            method: 'google_oauth',
            remember: true,
            googleData: googleUserData
        });
        
    } catch (error) {
        showError('Network error. Please try again.');
        console.error('Google login error:', error);
    }
}

async function handleSuccessfulLogin(userData) {
    // Store user data
    const loginTime = new Date().toISOString();
    const userSession = {
        username: userData.username,
        email: userData.email,
        sessionId: AppState.session.id,
        loginTime: loginTime,
        userAgent: navigator.userAgent,
        loginMethod: userData.method,
        googleData: userData.googleData,
        preferences: {}
    };
    
    // Store in localStorage
    localStorage.setItem('gahan_user_v2', JSON.stringify(userSession));
    
    if (userData.remember) {
        localStorage.setItem('remember_user', 'true');
    }
    
    // Update AppState
    AppState.user = {
        loggedIn: true,
        data: userSession,
        preferences: userSession.preferences || {}
    };
    
    // Send login tracking event
    await sendTrackingEvent({
        type: 'login',
        eventType: 'login',
        metadata: {
            method: userData.method,
            username: userData.username
        }
    });
    
    // Update counters
    await updateEnhancedCounters();
    
    // Show success screen
    showSuccessScreen(userData.username, userData.email, loginTime, userData.method);
    
    // Show success toast
    showToast(`Welcome back, ${userData.username}!`, 'success');
}

// ======================================================================
// ENHANCED UI FUNCTIONS
// ======================================================================

function showSuccessScreen(username, email, loginTime, method) {
    // Hide login screen
    Elements.loginScreen.style.display = 'none';
    
    // Update user info
    document.getElementById('displayUsername').textContent = username;
    document.getElementById('displayEmail').textContent = email;
    document.getElementById('displayMethod').textContent = method === 'google_oauth' ? 'Google OAuth' : 'Traditional';
    document.getElementById('displaySessionTime').textContent = new Date(loginTime).toLocaleString();
    document.getElementById('displayVisitorId').textContent = AppState.session.visitorId;
    
    // Show success screen with animation
    Elements.successScreen.style.display = 'block';
    Elements.successScreen.classList.add('fade-in');
}

function showError(message) {
    Elements.errorText.textContent = message;
    Elements.errorMessage.style.display = 'block';
}

function hideError() {
    Elements.errorMessage.style.display = 'none';
}

function showLoading(message) {
    if (Elements.loadingProgress) {
        Elements.loadingProgress.textContent = message;
    }
    Elements.loading.style.display = 'flex';
}

function hideLoading() {
    Elements.loading.style.opacity = '0';
    setTimeout(() => {
        Elements.loading.style.display = 'none';
        Elements.loading.style.opacity = '1';
    }, 300);
}

function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
        <span>${message}</span>
    `;
    
    Elements.toastContainer.appendChild(toast);
    
    // Show toast
    setTimeout(() => toast.classList.add('show'), 10);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 300);
    }, 5000);
    
    // Add to queue
    AppState.ui.toastQueue.push({ message, type, timestamp: Date.now() });
}

// ======================================================================
// TAB MANAGEMENT
// ======================================================================

function switchTab(tabName) {
    // Update active tab button
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.textContent.includes(tabName === 'traditional' ? 'Traditional' : 'Google')) {
            btn.classList.add('active');
        }
    });
    
    // Show active tab content
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    
    document.getElementById(`${tabName}Tab`).classList.add('active');
    AppState.ui.activeTab = tabName;
}

function switchAnalyticsTab(tabName) {
    // Update active tab button
    document.querySelectorAll('.modal-tab').forEach(btn => {
        btn.classList.remove('active');
        if (btn.textContent.includes(tabName)) {
            btn.classList.add('active');
        }
    });
    
    // Show active tab content
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    
    document.getElementById(`${tabName}Tab`).classList.add('active');
    
    // Load tab-specific data
    switch(tabName) {
        case 'realtime':
            loadRealTimeData();
            break;
        case 'geography':
            loadGeographyData();
            break;
        case 'devices':
            loadDeviceData();
            break;
    }
}

// ======================================================================
// PRIVACY MANAGEMENT
// ======================================================================

async function checkPrivacyStatus() {
    const privacyAccepted = localStorage.getItem('privacy_accepted_v2');
    const firstVisit = !localStorage.getItem('visitor_first_seen_v2');
    
    if (!privacyAccepted && firstVisit) {
        // Show privacy modal on first visit
        setTimeout(() => {
            showPrivacyModal();
        }, 2000);
    }
    
    AppState.analytics.privacyAccepted = !!privacyAccepted;
    return privacyAccepted;
}

function showPrivacyModal() {
    Elements.privacyModal.style.display = 'flex';
}

function hidePrivacyModal() {
    Elements.privacyModal.style.display = 'none';
}

function acceptPrivacy() {
    localStorage.setItem('privacy_accepted_v2', 'true');
    localStorage.setItem('privacy_accepted_date', new Date().toISOString());
    AppState.analytics.privacyAccepted = true;
    hidePrivacyModal();
    showToast('Privacy preferences saved!', 'success');
}

function showPrivacySettings() {
    hidePrivacyModal();
    // Implement privacy settings panel
    showToast('Privacy settings panel coming soon!', 'info');
}

// ======================================================================
// ANALYTICS MODAL FUNCTIONS
// ======================================================================

function showAnalyticsModal() {
    Elements.analyticsModal.style.display = 'flex';
    updateAnalyticsModal();
    loadRealTimeData();
}

function hideAnalyticsModal() {
    Elements.analyticsModal.style.display = 'none';
}

function updateAnalyticsModal() {
    const { total, unique, live } = AppState.analytics.counters;
    
    document.getElementById('modalTotal').textContent = total;
    document.getElementById('modalUnique').textContent = unique;
    document.getElementById('modalLive').textContent = live;
    document.getElementById('lastUpdateTime').textContent = new Date().toLocaleTimeString();
}

async function loadRealTimeData() {
    try {
        const response = await fetch(`${CONFIG.SHEET_URL}?action=getRealTime&_=${Date.now()}`);
        const data = await response.json();
        
        if (data && data.recent_activity) {
            const container = document.getElementById('liveVisitorsList');
            container.innerHTML = '';
            
            if (data.recent_activity.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: var(--gray);">
                        <i class="fas fa-users-slash" style="font-size: 30px; margin-bottom: 15px;"></i>
                        <p>No recent activity</p>
                    </div>
                `;
                return;
            }
            
            data.recent_activity.forEach(activity => {
                const item = document.createElement('div');
                item.style.cssText = `
                    padding: 12px 15px;
                    margin-bottom: 8px;
                    background: var(--light);
                    border-radius: 8px;
                    border-left: 4px solid var(--primary);
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                `;
                
                const time = new Date(activity.time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                item.innerHTML = `
                    <div>
                        <div style="font-weight: 600; color: var(--dark);">${activity.eventType}</div>
                        <div style="font-size: 12px; color: var(--gray);">${activity.page}</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 14px; color: var(--primary);">${time}</div>
                        <div style="font-size: 11px; color: var(--gray);">${activity.country || 'Unknown'}</div>
                    </div>
                `;
                
                container.appendChild(item);
            });
        }
    } catch (error) {
        console.error('Failed to load real-time data:', error);
    }
}

// ======================================================================
// BACKGROUND PROCESSES
// ======================================================================

function startBackgroundProcesses() {
    // Update counters every 30 seconds
    setInterval(updateEnhancedCounters, CONFIG.REFRESH_INTERVAL);
    
    // Retry failed events every 5 minutes
    setInterval(retryFailedEvents, 300000);
    
    // Update session duration every minute
    setInterval(updateSessionDuration, 60000);
}

function updateSessionDuration() {
    const now = Date.now();
    const duration = Math.round((now - AppState.session.startTime) / 1000);
    
    // Update in localStorage
    const userData = JSON.parse(localStorage.getItem('gahan_user_v2') || '{}');
    if (userData.loginTime) {
        userData.sessionDuration = duration;
        localStorage.setItem('gahan_user_v2', JSON.stringify(userData));
    }
}

// ======================================================================
// EVENT LISTENERS SETUP
// ======================================================================

function setupEventListeners() {
    // Form interactions
    document.getElementById('username').addEventListener('keypress', e => {
        if (e.key === 'Enter') {
            document.getElementById('password').focus();
        }
    });
    
    document.getElementById('password').addEventListener('keypress', e => {
        if (e.key === 'Enter') {
            loginUser();
        }
    });
    
    // Password toggle
    document.querySelector('.password-toggle').addEventListener('click', togglePassword);
    
    // Window events
    window.addEventListener('online', () => {
        showToast('Connection restored', 'success');
        updateEnhancedCounters();
        retryFailedEvents();
    });
    
    window.addEventListener('offline', () => {
        showToast('Connection lost. Working offline...', 'warning');
    });
    
    // Error handling
    window.addEventListener('error', (event) => {
        console.error('Global error:', event.error);
        sendTrackingEvent({
            type: 'error',
            eventType: 'javascript_error',
            metadata: {
                message: event.message,
                filename: event.filename,
                lineno: event.lineno,
                colno: event.colno
            }
        }).catch(console.error);
    });
    
    // Unhandled promise rejections
    window.addEventListener('unhandledrejection', (event) => {
        console.error('Unhandled promise rejection:', event.reason);
        sendTrackingEvent({
            type: 'error',
            eventType: 'promise_rejection',
            metadata: {
                reason: event.reason?.toString() || 'Unknown'
            }
        }).catch(console.error);
    });
}

// ======================================================================
// UTILITY FUNCTIONS
// ======================================================================

function togglePassword() {
    const passwordInput = document.getElementById('password');
    const toggleIcon = document.querySelector('.password-toggle i');
    
    if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        toggleIcon.className = 'fas fa-eye-slash';
    } else {
        passwordInput.type = 'password';
        toggleIcon.className = 'fas fa-eye';
    }
}

function toggleDarkMode() {
    AppState.ui.darkMode = !AppState.ui.darkMode;
    document.body.classList.toggle('dark-mode', AppState.ui.darkMode);
    localStorage.setItem('dark_mode', AppState.ui.darkMode);
    
    showToast(AppState.ui.darkMode ? 'Dark mode enabled' : 'Light mode enabled', 'success');
}

function loadUserPreferences() {
    // Load dark mode preference
    const darkMode = localStorage.getItem('dark_mode') === 'true';
    if (darkMode) {
        AppState.ui.darkMode = true;
        document.body.classList.add('dark-mode');
    }
    
    // Load other preferences
    AppState.user.preferences = JSON.parse(localStorage.getItem('user_preferences') || '{}');
}

async function checkExistingLogin() {
    const userSession = JSON.parse(localStorage.getItem('gahan_user_v2') || '{}');
    
    if (userSession.loginTime) {
        const loginTime = new Date(userSession.loginTime);
        const now = new Date();
        const hoursSinceLogin = (now - loginTime) / (1000 * 60 * 60);
        
        // Check if session is still valid (24 hours)
        if (hoursSinceLogin < 24) {
            AppState.user = {
                loggedIn: true,
                data: userSession,
                preferences: userSession.preferences || {}
            };
            
            showSuccessScreen(
                userSession.username,
                userSession.email,
                userSession.loginTime,
                userSession.loginMethod
            );
            
            // Update counters
            await updateEnhancedCounters();
            
            return true;
        } else {
            // Session expired
            localStorage.removeItem('gahan_user_v2');
        }
    }
    
    return false;
}

function logout() {
    // Send logout event
    sendTrackingEvent({
        type: 'logout',
        eventType: 'logout',
        metadata: {
            sessionDuration: Date.now() - AppState.session.startTime,
            pageViews: AppState.session.pageViews
        }
    });
    
    // Send session end
    sendTrackingEvent({
        type: 'session_end',
        eventType: 'session_end'
    });
    
    // Clear user data
    localStorage.removeItem('gahan_user_v2');
    localStorage.removeItem('remember_user');
    localStorage.removeItem('google_user_data');
    
    // Reset AppState
    AppState.user = {
        loggedIn: false,
        data: null,
        preferences: {}
    };
    
    // Reload page
    location.reload();
}

function goToContent(contentType) {
    // Send content access event
    sendTrackingEvent({
        type: 'content_access',
        eventType: 'content_access',
        metadata: {
            contentType: contentType,
            user: AppState.user.data?.username || 'guest'
        }
    });
    
    // Store access info
    localStorage.setItem('last_content_access', contentType);
    localStorage.setItem('last_access_time', new Date().toISOString());
    
    // Show loading state
    document.getElementById('successScreen').innerHTML = `
        <div style="text-align: center; padding: 60px;">
            <div class="loading-spinner" style="margin: 0 auto 30px;"></div>
            <h2 style="color: var(--primary);">Loading ${contentType.toUpperCase()} Content</h2>
            <p style="color: var(--gray); margin-top: 15px;">Preparing enhanced learning materials...</p>
        </div>
    `;
    
    // Redirect after delay
    setTimeout(() => {
        const pages = {
            odd: 'odd.html',
            even: 'even.html',
            obj: 'obj.html'
        };
        window.location.href = pages[contentType] || 'index.html';
    }, 1500);
}

function showSessionInfo() {
    const sessionInfo = `
        Session ID: ${AppState.session.id.substring(0, 20)}...
        Visitor ID: ${AppState.session.visitorId}
        Session Start: ${new Date(AppState.session.startTime).toLocaleString()}
        Page Views: ${AppState.session.pageViews}
        Events Sent: ${AppState.session.events.length}
        User Agent: ${navigator.userAgent.substring(0, 50)}...
    `;
    
    alert('Session Information:\n\n' + sessionInfo);
}

function googleLogout() {
    const googleUserData = JSON.parse(localStorage.getItem('google_user_data'));
    
    if (googleUserData && googleUserData.token) {
        if (typeof google !== 'undefined' && google.accounts && google.accounts.id) {
            google.accounts.id.revoke(googleUserData.token, done => {
                console.log('Google token revoked');
            });
        }
    }
    
    localStorage.removeItem('google_user_data');
    document.getElementById('googleUserInfo').style.display = 'none';
    document.querySelector('.g_id_signin').style.display = 'block';
}

async function initializeAnalytics() {
    // Initial counter update
    await updateEnhancedCounters();
    
    // Load additional analytics data
    setTimeout(() => {
        updateAnalyticsModal();
    }, 2000);
}

// ======================================================================
// INITIALIZATION
// ======================================================================

// Start the application when DOM is loaded
document.addEventListener('DOMContentLoaded', initializeApp);

// Fallback initialization
window.addEventListener('load', () => {
    if (!AppState.session.id) {
        console.log('Fallback initialization...');
        initializeApp();
    }
});

// Service Worker registration for offline capabilities
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').then(registration => {
            console.log('ServiceWorker registered:', registration.scope);
        }).catch(error => {
            console.log('ServiceWorker registration failed:', error);
        });
    });
}
</script>

</body>
</html>